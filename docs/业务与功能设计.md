# 算数平台 · 业务与功能设计

本文档记录业务背景与系统功能设计，供需求澄清、接口设计与实现时查阅。

---

## 一、业务背景

### 1.1 车队与车辆

- 车队有车辆若干；**每辆车 = 司机 + 售票员**，司机默认绑定该车，故以**车**为认定单位即可。
- **车辆标识**：车牌简称，一般为车牌号后三位，**纯数字**（如 123、321）。
- **售票员标识**：同样用**车牌后三位**标识，且**售票员来自某辆车**——即「车号既能辨别车，也能辨别这个售票员是由哪辆车出的」。
- **入账记录含义**：一条入账记录中若**车辆=123、售票员=321**，表示**321 车的售票员跟的是 123 车**。即：车辆字段=实际营运的车，售票员字段=跟车售票员所属的车号。
- 车队内**售票员统一调配、统一入账、收入平分**，因此通常本车售票员不跟本车。
- 售票员排班**每月一换**，一般**下月 1 号前**出下月排班表，由人工调配；需**保留历史排班**便于后续统计。

### 1.2 车辆排班（轮休）

- **每天**有部分车辆轮休；轮休车辆**一般不产生收入**，但**不绝对**，偶尔有轮休车加班产生收入。
- **车辆排班（轮休）为可选项**：
  - 若**无当日排班配置**，则默认**全部车辆营运**。
  - 主要用途：管理员登录时**提醒**当天还有哪些车未报账。
  - 支持管理员**当天即时配置**当天某车休息/营运。
- **排班配置时间范围**：只能配置**从当天起往后最多一个月**。
- 每辆车都是每天营运结束后**统一报当天所有账目**，不存在「跑一半再报轮休」；若跑一半不跑，当天也算营运。因此只有**轮休车加班**，没有**营运车半途改休**，无需考虑「已录收入后再改轮休」的冲突。

### 1.3 收入构成与入账

- **入账节奏**：每天营运结束后，各车向管理员提交收入情况，**由管理员统一录入**。
- **收入单位**：以「出发地 → 目的地 → 回到出发地」为一**转**；每辆车每天**最多 5 转**，系统记录各转收入（不一定满 5 转，以实际提交为准）。
- **第 5 转**：汇总**收入**时正常计入；汇总**转数**时**不计入**（有收入也不算转数）。**转数只用于统计，不参与金额分配**；理论上每天除第 5 转外，有一转收入则算跑了一转；**月转数 = 当月各日转数之和**。
- **微信收入**：单独一项，每天入账时汇总一次，与 5 转的现金收入区分，**计入总收入**。
- **补油款**：每车每天**一笔**，记作**正数**存储，参与计算时**用于扣减**。
- **奖罚**：每车每天**一个净额**，用**正负值**直接参与计算即可。
- **当日单车收入公式**：  
  **5 转收入 + 微信收入 − 补油款 ± 奖罚 = 当日该车净收入**
- **录入要求**：最好有**详细收入构成**；数据需包含营业额、净收入、当日转数（供后续统计）。
- **轮休车辆加班**：轮休车辆可以录入收入，标记为加班，便于后续统计。
- **操作员记录**：创建和更新收入记录时都记录操作员姓名。
- **转数收入显示**：未录入的转数（null）或录入为0的转数（0.0），前端显示时显示为空，不显示"0.0"。

### 1.4 分配与结账

- **分配规则**：**所有车辆净收入 / 车辆总数**，分**按天**和**按月**两个维度；需支持按需统计与导出。
- **车辆总数**：分配时的分母为**在册车辆总数**；**轮休车辆也参与分配**（即分母固定为在册数，不因轮休减少）。
- **钱款**：理论上车辆每天只做**账目汇总**，实际钱款**各自**保管；**月底结账**时，按平均收入与单车收入算**收付金额**：
  - **车辆视角**：收入**低于**平均值 → **应收钱** → 记**正数**；收入**高于**平均值 → **应付钱** → 记**负数**。
- **月底结账顺序**：**月总收入 − 管理员服务费（每月一笔总服务费）→ 再 ÷ 车辆总数** 得到单车月收入，再计算每辆车的收付正负值。**顺序固定，不可调**。
- **管理员工资**：每月一笔总服务费，可配置，用**数据库表单独管理**。

### 1.8 每日统计

- **统计目的**：实时展示当天收入汇总情况，包括总额、平均值以及每辆车相对于平均值的正负值。
- **统计内容**：
  - **总营业额**：当天所有已录入车辆营业额之和
  - **总净收入**：当天所有已录入车辆净收入之和
  - **平均营业额**：总营业额 ÷ **所有在册车辆总数**（无论是否录入，轮休车辆也参与）
  - **平均净收入**：总净收入 ÷ **所有在册车辆总数**（无论是否录入，轮休车辆也参与）
  - **车辆正负值**：**所有在册车辆**的营业额/净收入相对于平均值的差值（正数表示高于平均值，负数表示低于平均值）
    - **已录入车辆**：显示实际营业额/净收入及其差值
    - **未录入车辆**：营业额和净收入显示为0，差值为负的平均值
- **重要规则**：
  - **分母固定**：平均值计算的分母是**所有在册车辆总数**，不因是否录入或轮休而变化
  - **所有车辆参与**：统计表格显示所有在册车辆，未录入的车辆也显示（值为0）
- **数据更新机制**：
  - **实时更新**：每次保存/更新/删除收入记录时，自动触发统计更新
  - **定时任务**：每天凌晨运行，重新计算前一天统计（兜底机制）
  - **手动触发**：提供后台命令手动重新计算指定日期统计（用于数据修复）
- **数据存储**：使用 `daily_statistics` 表单独存储统计数据，便于快速查询和历史统计

### 1.5 月表与精度修正

- **月表不允许手动修改**自动汇总结果；但考虑到**小数精度**可能导致「月表自动结算金额」与「日表汇总金额」存在细微误差：
  - 月表保留**自动结算金额**及**自动每车收入/收付**；
  - 增加**手动修正结算金额**字段，以及**手动修正后的每车收入/收付**；
  - 最终月表展示/导出时同时包含：自动结算 + 自动每车收付、手动修正结算 + 手动修正后每车收付；**以手动修正为准**（若已填写）用于最终结账或导出。这样既保证数据可追溯，又允许在合理范围内做一次性修正。

### 1.6 售票员排班

- **必配项**；理论上每月 1 号前配好当月排班。
- 需能**记录历史排班**，便于后续统计。

### 1.7 金额精度

- **所有涉及金额**的字段（收入、补油款、奖罚、分配、收付、服务费等）：**保留一位小数**。
- 多余小数位**直接截断**，**不四舍五入**。（实现时入库、计算与展示均按此规则统一处理。）

---

## 二、角色与账户

| 账户     | 说明                                       |
|----------|--------------------------------------------|
| admin    | 管理员，录入、排班、统计、导出等全权限     |
| pyh66    | 日常管理员，同上（与 admin 权限一致）     |
| **daochu** | **仅数据导出**：只能访问「数据导出」页面，用于展示指定月份数据及一键导出，方便后续交给他人做导出操作 |

- 录入、排班、统计、导出（除 daochu 仅导出页）均为**管理员**权限；钱款由**各自**保管，非系统角色。

---

## 三、功能设计（待展开）

- **数据概览**：首页等
- **车队管理**：车辆排班（轮休）、售票员跟车配置、车辆管理
- **数据统计**：按日/月汇总、分配、管理员服务费配置等
- **数据导出**：按月份展示 + 一键导出指定月份数据；**daochu 账户仅能访问本页**

---

## 四、变更记录

| 日期       | 说明                         |
|------------|------------------------------|
| 2025-02-10 | 初建文档                     |
| 2025-02-10 | 录入业务背景与待确认问题     |
| 2025-02-10 | 澄清结论、月表修正设计、daochu 账户 |
| 2025-02-10 | 补充金额精度：一位小数、截断不四舍五入 |
| 2026-02-11 | 新增每日统计功能设计（1.8节） |
